---
const consentKey = "cookie_consent";

const readEnv = (key: string): string =>
  String((import.meta as any)?.env?.[key] ?? (process as any)?.env?.[key] ?? "").trim();

const adsenseClient =
  readEnv("PUBLIC_ADSENSE_CLIENT") ||
  // Default to the live AdSense client so ads render even if env vars are missing.
  "ca-pub-8677561632094995";

const pubSlug = adsenseClient?.replace(/^ca-/, "") ?? "";
const defaultFundingChoicesScriptSrc =
  pubSlug ? `https://fundingchoicesmessages.google.com/i/${encodeURIComponent(pubSlug)}?ers=1` : "";
const fundingChoicesScriptSrc = readEnv("PUBLIC_FUNDING_CHOICES_SCRIPT_SRC") || defaultFundingChoicesScriptSrc;
const useFundingChoices = Boolean(fundingChoicesScriptSrc) && !import.meta.env.DEV;

const fallbackSlots = {
  default: "8602706218",
  home: "3154938417",
  toolkit: "7120080063",
  tool: "4855032895",
  use_case: "4441752310",
} as const;

const defaultSlot = readEnv("PUBLIC_ADSENSE_SLOT_DEFAULT") || fallbackSlots.default;

const slotByPlacement = {
  home: readEnv("PUBLIC_ADSENSE_SLOT_HOME") || fallbackSlots.home || defaultSlot,
  toolkit: readEnv("PUBLIC_ADSENSE_SLOT_TOOLKIT") || fallbackSlots.toolkit || defaultSlot,
  tool: readEnv("PUBLIC_ADSENSE_SLOT_TOOL") || fallbackSlots.tool || defaultSlot,
  use_case: readEnv("PUBLIC_ADSENSE_SLOT_USE_CASE") || fallbackSlots.use_case || defaultSlot,
} as const;

const {
  slot,
  placement,
  format = "auto",
  responsive = true,
  containerClass = "",
  containerStyle = "",
  adStyle = "display:block",
} = Astro.props;

const resolvedSlot = slot ?? (placement ? slotByPlacement[placement] : defaultSlot);
---

<div class={`ad ${containerClass}`.trim()} style={containerStyle}>
  <ins
    class="adsbygoogle"
    style={adStyle}
    data-ad-client={adsenseClient}
    data-ad-slot={resolvedSlot}
    data-ad-format={format}
    data-full-width-responsive={responsive ? "true" : "false"}
  ></ins>
  <script is:inline define:vars={{ consentKey, useFundingChoices }}>
    (() => {
      const shouldRequestAds = () => {
        if (useFundingChoices) return true;
        try {
          return localStorage.getItem(consentKey) === "accepted";
        } catch {
          return false;
        }
      };

      if (!shouldRequestAds()) return;
      try {
        // @ts-ignore
        (window.adsbygoogle = window.adsbygoogle || []).push({});
      } catch {}
    })();
  </script>
</div>
