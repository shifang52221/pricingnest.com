---
import "../styles/global.css";
import CookieBanner from "../components/CookieBanner.astro";

const siteName = process.env.PUBLIC_SITE_NAME ?? import.meta.env.PUBLIC_SITE_NAME ?? "PricingNest";
const siteUrl = (Astro.site?.toString() ?? process.env.PUBLIC_SITE_URL ?? import.meta.env.PUBLIC_SITE_URL ?? "https://pricingnest.com").replace(/\/$/, "");
const canonical = new URL(Astro.url.pathname, siteUrl).toString();
const title = Astro.props.title ?? siteName;
const description =
  Astro.props.description ??
  "A lightweight collection of SaaS pricing and cloud cost tools designed for SEO-friendly, high-intent queries.";
const robots = Astro.props.robots ?? "index,follow";

const adsenseClient =
  process.env.PUBLIC_ADSENSE_CLIENT ??
  import.meta.env.PUBLIC_ADSENSE_CLIENT ??
  // Default to the live AdSense client so verification/review can succeed even if env vars are missing.
  "ca-pub-8677561632094995";
const ga4Id =
  process.env.PUBLIC_GA4_ID ??
  import.meta.env.PUBLIC_GA4_ID ??
  // Fallback so GA4 works even if the build environment fails to inject PUBLIC_GA4_ID.
  "G-C3L1B71H17";
const contactEmail =
  process.env.PUBLIC_CONTACT_EMAIL ?? import.meta.env.PUBLIC_CONTACT_EMAIL ?? "admin@pricingnest.com";

const fundingChoicesScriptSrc = process.env.PUBLIC_FUNDING_CHOICES_SCRIPT_SRC ?? import.meta.env.PUBLIC_FUNDING_CHOICES_SCRIPT_SRC ?? "";
const useFundingChoices = Boolean(fundingChoicesScriptSrc);

const ogImage = `${siteUrl}/og.svg`;
---
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="canonical" href={canonical} />
    <title>{title}</title>
    <meta name="description" content={description} />
    <meta name="robots" content={robots} />
    <meta name="googlebot" content={robots} />
    {adsenseClient ? <meta name="google-adsense-account" content={adsenseClient} /> : null}
    <meta name="theme-color" content="#ffffff" />
    <meta name="application-name" content={siteName} />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:url" content={canonical} />
    <meta property="og:type" content="website" />
    <meta property="og:site_name" content={siteName} />
    <meta property="og:image" content={ogImage} />
    <meta property="og:image:alt" content={`${siteName} preview`} />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:image" content={ogImage} />
    <meta name="twitter:image:alt" content={`${siteName} preview`} />
    <link rel="alternate" href={canonical} hreflang="en" />
    <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
    <slot name="head" />
    {useFundingChoices && fundingChoicesScriptSrc ? (
      <script async src={fundingChoicesScriptSrc}></script>
    ) : null}
    {adsenseClient ? (
      <script
        async
        src={`https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=${encodeURIComponent(adsenseClient)}`}
        crossorigin="anonymous"
      ></script>
    ) : null}
    <script is:inline define:vars={{ ga4Id, useFundingChoices }}>
      (() => {
        const consentKey = "cookie_consent";
        const getConsent = () => {
          try {
            return localStorage.getItem(consentKey);
          } catch {
            return null;
          }
        };
        const consent = getConsent();

        // GA4/Consent Mode:
        // - If using Funding Choices, the CMP will update consent state.
        // - Otherwise, we use the local cookie banner state for a simple consent flow.
        if (ga4Id) {
          // @ts-ignore
          window.dataLayer = window.dataLayer || [];
          // @ts-ignore
          window.gtag =
            // @ts-ignore
            window.gtag || function () { window.dataLayer.push(arguments); };

          // @ts-ignore
          window.gtag("consent", "default", {
            ad_storage: "denied",
            ad_user_data: "denied",
            ad_personalization: "denied",
            analytics_storage: "denied",
            functionality_storage: "granted",
            personalization_storage: "denied",
            security_storage: "granted",
            wait_for_update: 500
          });

          if (!useFundingChoices && consent === "accepted") {
            // @ts-ignore
            window.gtag("consent", "update", {
              ad_storage: "granted",
              ad_user_data: "granted",
              ad_personalization: "granted",
              analytics_storage: "granted",
              functionality_storage: "granted",
              personalization_storage: "granted",
              security_storage: "granted"
            });
          }

          const g = document.createElement("script");
          g.async = true;
          g.src = "https://www.googletagmanager.com/gtag/js?id=" + encodeURIComponent(ga4Id);
          document.head.appendChild(g);

          // If Funding Choices is enabled, allow Consent Mode to control collection after consent updates.
          // Otherwise, only start collecting after consent is accepted.
          if (useFundingChoices || consent === "accepted") {
            // @ts-ignore
            window.gtag("js", new Date());
            // @ts-ignore
            window.gtag("config", ga4Id);
          }
        }

        // Ads script is loaded unconditionally (for AdSense review/verification).
        // Ad requests/slots are gated in the ad component when not using Funding Choices.
      })();
    </script>
  </head>
  <body>
    <header class="header">
      <div class="container nav">
        <a class="brand" href="/">
          <img class="logo" src="/logo.svg" width="28" height="28" alt="" aria-hidden="true" />
          <span>{siteName}</span>
        </a>
        <nav class="muted">
          <a href="/saas-pricing/">Toolkit</a>
          <span class="muted"> | </span>
          <a href="/guides/">Guides</a>
          <span class="muted"> | </span>
          <a href="/about/">About</a>
          <span class="muted"> | </span>
          <a href="/contact/">Contact</a>
          <span class="muted"> | </span>
          <a href="/privacy-policy/">Privacy</a>
          <span class="muted"> | </span>
          <a href="/cookie-policy/">Cookies</a>
          <span class="muted"> | </span>
          <a href="/terms/">Terms</a>
        </nav>
      </div>
    </header>
    <main class="main">
      <div class="container">
        <slot />
      </div>
    </main>
    <footer class="footer">
      <div class="container">
        <div class="footer-grid">
          <div>
            <div class="footer-title">{siteName}</div>
            <div class="footer-text">Input-driven calculators for SaaS pricing and cloud unit economics.</div>
          </div>
          <div>
            <div class="footer-title">Toolkit</div>
            <div class="footer-links">
              <a href="/saas-pricing/">All tools</a>
              <a href="/guides/">Guides</a>
              <a href="/saas-pricing/use-cases/">Use cases</a>
              <a href="/saas-pricing/use-cases/api-pricing/">API pricing use case</a>
              <a href="/saas-pricing/use-cases/infra-cost-recovery/">Infra cost recovery</a>
              <a href="/saas-pricing/use-cases/unit-economics/">Unit economics</a>
            </div>
          </div>
          <div>
            <div class="footer-title">Legal</div>
            <div class="footer-links">
              <a href="/about/">About</a>
              <a href="/privacy-policy/">Privacy policy</a>
              <a href="/cookie-policy/">Cookie policy</a>
              <a href="/cookie-policy/" data-cookie-open>Cookie settings</a>
              <a href="/terms/">Terms</a>
            </div>
          </div>
          <div>
            <div class="footer-title">Contact</div>
            <div class="footer-links">
              <a href="/contact/">Contact</a>
              {contactEmail ? <a href={`mailto:${contactEmail}`}>{contactEmail}</a> : null}
            </div>
          </div>
        </div>
        <div class="footer-bottom">
          <div class="footer-text">Tools provide estimates only. Use your own costs and assumptions.</div>
          <div class="footer-text">(c) {new Date().getFullYear()} {siteName}</div>
        </div>
      </div>
    </footer>
    {useFundingChoices ? null : <CookieBanner />}
  </body>
</html>
