---
import BaseLayout from "../../layouts/BaseLayout.astro";
import AdSlot from "../../components/AdSlot.astro";
import { getToolBySlug, TOOLS, type ToolDefinition } from "../../lib/tools";
import toolPageScriptUrl from "../../scripts/tool-page.js?url";
import { compute } from "../../scripts/calculators";

export function getStaticPaths() {
  return TOOLS.map((tool) => ({ params: { slug: tool.slug } }));
}

const { slug } = Astro.params as { slug: string };
const tool = getToolBySlug(slug);
if (!tool) throw new Error(`Unknown tool slug: ${slug}`);

const relatedTools: ToolDefinition[] = tool.related
  .map((s) => getToolBySlug(s))
  .filter((t): t is ToolDefinition => Boolean(t));

const hasHowItWorks = Array.isArray(tool.howItWorks) && tool.howItWorks.length > 0;
const hasFaq = Array.isArray(tool.faq) && tool.faq.length > 0;
const hasAssumptions = Array.isArray(tool.assumptions) && tool.assumptions.length > 0;

const siteUrl = (Astro.site?.toString() ?? "https://pricingnest.com").replace(/\/$/, "");
const canonical = new URL(Astro.url.pathname, siteUrl).toString();

function formatCurrency(currency: string, value: number): string {
  const formatter = new Intl.NumberFormat("en-US", {
    style: "currency",
    currency,
    maximumFractionDigits: value < 1 ? 6 : 2
  });
  return formatter.format(value);
}

function formatNumber(value: number): string {
  const formatter = new Intl.NumberFormat("en-US", { maximumFractionDigits: 6 });
  return formatter.format(value);
}

function formatPercent(value: number): string {
  const formatter = new Intl.NumberFormat("en-US", { maximumFractionDigits: 2 });
  return `${formatter.format(value)}%`;
}

function buildDefaultInputs(tool: ToolDefinition): Record<string, string> {
  const inputs: Record<string, string> = {};
  for (const input of tool.inputs) inputs[input.name] = input.defaultValue;
  return inputs;
}

const defaultInputs = buildDefaultInputs(tool);
const defaultCurrency = defaultInputs.currency || "USD";
const defaultResult = compute(tool.slug, defaultInputs);

const exampleOutputs = tool.outputs.map((out) => {
  const raw = defaultResult[out.name];
  const value =
    typeof raw === "number"
      ? out.format === "currency"
        ? formatCurrency(defaultCurrency, raw)
        : out.format === "percent"
          ? formatPercent(raw)
          : formatNumber(raw)
      : raw == null
        ? "-"
        : String(raw);

  return { ...out, value };
});

const keyInputs = tool.inputs.filter((i) => i.name !== "currency").slice(0, 3);
const websiteId = `${siteUrl}/#website`;
const breadcrumbId = `${canonical}#breadcrumb`;

const graph: any[] = [
  {
    "@type": "WebSite",
    "@id": websiteId,
    url: siteUrl,
    name: "PricingNest"
  },
  {
    "@type": "WebPage",
    "@id": canonical,
    url: canonical,
    name: tool.title,
    description: tool.description,
    isPartOf: { "@id": websiteId },
    breadcrumb: { "@id": breadcrumbId }
  },
  {
    "@type": "SoftwareApplication",
    name: tool.title,
    applicationCategory: "BusinessApplication",
    operatingSystem: "Web",
    url: canonical,
    description: tool.description,
    mainEntityOfPage: { "@id": canonical },
    isPartOf: { "@id": websiteId },
    offers: { "@type": "Offer", price: "0", priceCurrency: "USD" }
  },
  {
    "@type": "BreadcrumbList",
    "@id": breadcrumbId,
    itemListElement: [
      { "@type": "ListItem", position: 1, name: "Home", item: new URL("/", siteUrl).toString() },
      { "@type": "ListItem", position: 2, name: "SaaS Pricing Toolkit", item: new URL("/saas-pricing/", siteUrl).toString() },
      { "@type": "ListItem", position: 3, name: tool.title, item: canonical }
    ]
  }
];

if (tool.faq && tool.faq.length > 0) {
  graph.push({
    "@type": "FAQPage",
    mainEntity: tool.faq.map((f) => ({
      "@type": "Question",
      name: f.q,
      acceptedAnswer: { "@type": "Answer", text: f.a }
    }))
  });
}

const jsonLd = { "@context": "https://schema.org", "@graph": graph };

const useCaseLinks = (() => {
  const unitEconomics = new Set([
    "mrr-calculator",
    "arr-calculator",
    "churn-impact-calculator",
    "ltv-calculator",
    "cac-payback-period-calculator",
    "break-even-cac-calculator"
  ]);

  const experiments = new Set(["pricing-increase-impact-calculator", "annual-discount-calculator"]);

  const usagePricing = new Set([
    "usage-based-pricing-calculator",
    "seat-vs-usage-pricing-comparison",
    "api-pricing-calculator"
  ]);

  const infra = new Set([
    "bandwidth-cost-calculator",
    "storage-cost-calculator",
    "compute-cost-estimator",
    "monthly-cloud-cost-estimator"
  ]);

  const links: { href: string; label: string }[] = [{ href: "/saas-pricing/use-cases/", label: "All use cases" }];
  if (usagePricing.has(tool.slug)) links.push({ href: "/saas-pricing/use-cases/usage-based-pricing/", label: "Use case: usage-based pricing" });
  if (tool.slug === "api-pricing-calculator") links.push({ href: "/saas-pricing/use-cases/api-pricing/", label: "Use case: API pricing" });
  if (infra.has(tool.slug)) links.push({ href: "/saas-pricing/use-cases/infra-cost-recovery/", label: "Use case: infra cost recovery" });
  if (unitEconomics.has(tool.slug)) links.push({ href: "/saas-pricing/use-cases/unit-economics/", label: "Use case: SaaS unit economics" });
  if (experiments.has(tool.slug)) links.push({ href: "/saas-pricing/use-cases/pricing-experiments/", label: "Use case: pricing experiments" });
  return links;
})();

const guideLinks = (() => {
  const grossMarginRelated = new Set([
    "usage-based-pricing-calculator",
    "compute-cost-estimator",
    "bandwidth-cost-calculator",
    "storage-cost-calculator",
    "monthly-cloud-cost-estimator",
    "api-pricing-calculator"
  ]);

  const seatVsUsageRelated = new Set([
    "seat-vs-usage-pricing-comparison",
    "usage-based-pricing-calculator",
    "api-pricing-calculator"
  ]);

  const experimentsRelated = new Set([
    "pricing-increase-impact-calculator",
    "annual-discount-calculator",
    "churn-impact-calculator",
    "mrr-calculator"
  ]);

  const usageExamplesRelated = new Set(["usage-based-pricing-calculator", "api-pricing-calculator", "storage-cost-calculator"]);
  const annualDiscountRelated = new Set(["annual-discount-calculator", "pricing-increase-impact-calculator", "churn-impact-calculator"]);
  const apiPricingRelated = new Set(["api-pricing-calculator", "usage-based-pricing-calculator"]);
  const apiCostRelated = new Set(["api-cost-estimator", "api-pricing-calculator", "usage-based-pricing-calculator"]);
  const tieredUsageRelated = new Set(["tiered-usage-pricing-calculator", "usage-based-pricing-calculator", "seat-vs-usage-pricing-comparison"]);
  const storageRelated = new Set(["storage-cost-calculator", "bandwidth-cost-calculator", "price-per-gb-month-calculator"]);
  const metricsRelated = new Set([
    "mrr-calculator",
    "arr-calculator",
    "churn-impact-calculator",
    "ltv-calculator",
    "cac-payback-period-calculator",
    "break-even-cac-calculator"
  ]);

  const links: { href: string; label: string }[] = [];
  if (grossMarginRelated.has(tool.slug)) links.push({ href: "/guides/saas-gross-margin-targets/", label: "Guide: gross margin targets" });
  if (usageExamplesRelated.has(tool.slug)) links.push({ href: "/guides/usage-based-pricing-examples/", label: "Guide: usage pricing examples" });
  if (apiPricingRelated.has(tool.slug)) links.push({ href: "/guides/api-pricing-model/", label: "Guide: API pricing model" });
  if (apiCostRelated.has(tool.slug)) links.push({ href: "/guides/api-cost-estimation/", label: "Guide: API cost estimation" });
  if (tieredUsageRelated.has(tool.slug)) links.push({ href: "/guides/tiered-usage-pricing/", label: "Guide: tiered usage pricing" });
  if (storageRelated.has(tool.slug)) links.push({ href: "/guides/storage-costs-and-pricing/", label: "Guide: storage costs & pricing" });
  if (seatVsUsageRelated.has(tool.slug)) links.push({ href: "/guides/seat-vs-usage-pricing/", label: "Guide: seat vs usage" });
  if (experimentsRelated.has(tool.slug)) links.push({ href: "/guides/pricing-experiments-playbook/", label: "Guide: pricing experiments" });
  if (annualDiscountRelated.has(tool.slug)) links.push({ href: "/guides/annual-prepay-discount/", label: "Guide: annual discount" });
  if (metricsRelated.has(tool.slug)) links.push({ href: "/guides/saas-metrics-cheat-sheet/", label: "Guide: SaaS metrics cheat sheet" });
  links.push({ href: "/glossary/", label: "Glossary: SaaS metrics & pricing terms" });
  return links;
})();
---

<BaseLayout title={`${tool.title} | PricingNest`} description={tool.description}>
  <script slot="head" type="application/ld+json" set:html={JSON.stringify(jsonLd)} />

  <div data-tool={tool.slug}>
    {tool.presets && tool.presets.length > 0 ? (
      <script type="application/json" data-presets set:html={JSON.stringify(tool.presets)} />
    ) : null}

    <section class="hero">
      <h1>{tool.title}</h1>
      <p>{tool.description}</p>
      <nav class="crumbs" aria-label="Breadcrumb">
        <a href="/saas-pricing/">SaaS Pricing Toolkit</a>
        <span class="crumb-sep">/</span>
        <span aria-current="page">{tool.title}</span>
      </nav>
    </section>

    <div class="grid">
      <section class="card col8 split">
        <div>
          <div class="section-head">
            <h2>Inputs</h2>
            <div class="actions">
              <button type="button" data-reset>Reset</button>
              <button type="button" class="primary" data-download-csv>Download CSV</button>
            </div>
          </div>

          {tool.presets && tool.presets.length > 0 ? (
            <div class="field">
              <label for="preset">Presets</label>
              <select id="preset" data-presets-select>
                <option value="">Choose a preset...</option>
                {tool.presets.map((p) => (
                  <option value={p.label}>{p.label}</option>
                ))}
              </select>
            </div>
          ) : null}

          <form data-tool-form>
            {tool.inputs.map((input) => (
              <div class="field">
                <label for={input.name}>{input.label}</label>
                {input.type === "select" ? (
                  <select id={input.name} name={input.name} data-default={input.defaultValue}>
                    {(input.options ?? []).map((opt) => (
                      <option value={opt.value} selected={opt.value === input.defaultValue}>
                        {opt.label}
                      </option>
                    ))}
                  </select>
                ) : (
                  <input
                    id={input.name}
                    name={input.name}
                    type="number"
                    inputmode="decimal"
                    value={input.defaultValue}
                    data-default={input.defaultValue}
                    min={input.min}
                    step={input.step}
                  />
                )}
                {input.help ? <div class="help">{input.help}</div> : null}
              </div>
            ))}
          </form>
        </div>

        <div class="sticky">
          <h2 class="sticky-title">Results</h2>
          <div class="outputs">
            {tool.outputs.map((out) => (
              <div class="output" data-output={out.name} data-format={out.format}>
                <div class="label">{out.label}</div>
                <div class="value" data-output-value>-</div>
              </div>
            ))}
          </div>

          <div class="share">
            <div class="muted" style="font-size: 0.9rem; margin-bottom: 0.35rem;">Share link</div>
            <div class="output" style="padding: 0.75rem;">
              <div class="muted" style="word-break: break-all;" data-share-link>-</div>
              <div class="share-actions">
                <button type="button" data-copy-share>Copy share link</button>
                <a class="muted" href="/saas-pricing/">All tools</a>
              </div>
            </div>
          </div>
        </div>
      </section>

      <aside class="card col4">
        <h2>Related tools</h2>
        <div class="tools">
          {relatedTools.map((t) => (
            <a class="tool" href={`/saas-pricing/${t.slug}/`}>
              <strong>{t.title}</strong>
              <span>{t.description}</span>
            </a>
          ))}
        </div>

        <div style="margin-top: 1rem;">
          <div class="muted" style="font-size: 0.85rem;">Advertisement</div>
          <AdSlot placement="tool" containerStyle="margin-top: 0.5rem;" />
        </div>
      </aside>
    </div>

    <div class="grid" style="margin-top: 1rem;">
      <section class="card col8" id="guide">
        <h2>Guide</h2>
        <p class="muted" style="margin-top: 0.5rem;">
          This page is a calculator first, but it's also a quick reference you can share internally. Start with the
          presets, then adjust inputs and copy the share link. Example defaults for this tool are shown below.
        </p>

        <div class="toc" aria-label="On this page">
          <a href="#example">Example</a>
          <a href="#inputs">Inputs</a>
          <a href="#outputs">Outputs</a>
          {hasHowItWorks ? <a href="#how">How it works</a> : null}
          {hasFaq ? <a href="#faq">FAQ</a> : null}
        </div>

        <h2 id="example" style="margin-top: 1.25rem;">Example (defaults)</h2>
        <p class="muted" style="margin-top: 0.5rem;">
          Example inputs: {keyInputs.map((i, idx) => (
            <span>
              <strong>{i.label}</strong> = {i.defaultValue}{idx < keyInputs.length - 1 ? ", " : ""}
            </span>
          ))}
        </p>
        <div class="data-grid" style="margin-top: 0.8rem;">
          {exampleOutputs.map((out) => (
            <div class="data-card">
              <div class="data-label">{out.label}</div>
              <div class="data-value">{out.value}</div>
            </div>
          ))}
        </div>

        <h2 id="inputs" style="margin-top: 1.25rem;">Inputs explained</h2>
        <div class="data-table-wrap" style="margin-top: 0.65rem;">
          <table class="data-table">
            <thead>
              <tr>
                <th>Input</th>
                <th>Default</th>
                <th>Notes</th>
              </tr>
            </thead>
            <tbody>
              {tool.inputs.map((input) => (
                <tr>
                  <td>
                    <strong>{input.label}</strong>
                  </td>
                  <td><code>{input.defaultValue}</code></td>
                  <td class="muted">
                    {input.help ? input.help : "Adjust to match your product assumptions."}
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>

        <h2 id="outputs" style="margin-top: 1.25rem;">Outputs explained</h2>
        <div class="data-table-wrap" style="margin-top: 0.65rem;">
          <table class="data-table">
            <thead>
              <tr>
                <th>Output</th>
                <th>What it means</th>
              </tr>
            </thead>
            <tbody>
              {tool.outputs.map((out) => (
                <tr>
                  <td><strong>{out.label}</strong></td>
                  <td class="muted">
                    {out.format === "currency"
                      ? "A money value based on your selected currency."
                      : out.format === "percent"
                        ? "A percentage value derived from the inputs."
                        : out.format === "number"
                          ? "A numeric value derived from the inputs."
                          : "A text label derived from the inputs."}
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>

        {hasHowItWorks ? (
          <>
            <h2 id="how" style="margin-top: 1.25rem;">How it works</h2>
            <ul class="list">
              {tool.howItWorks?.map((item) => (
                <li>{item}</li>
              ))}
            </ul>
          </>
        ) : null}

        {hasFaq ? (
          <>
            <h2 id="faq" style="margin-top: 1.25rem;">FAQ</h2>
            <div class="faq">
              {tool.faq?.map((f) => (
                <details class="faq-item">
                  <summary>{f.q}</summary>
                  <div class="muted faq-answer">{f.a}</div>
                </details>
              ))}
            </div>
          </>
        ) : null}
      </section>

      <aside class="card col4">
        {hasAssumptions ? (
          <>
            <h2>Assumptions</h2>
            <ul class="list">
              {tool.assumptions?.map((item) => (
                <li>{item}</li>
              ))}
            </ul>
          </>
        ) : null}

        <h2 style="margin-top: 1.25rem;">Next steps</h2>
        <ul class="list">
          {useCaseLinks.map((l) => (
            <li><a href={l.href}>{l.label}</a></li>
          ))}
          {guideLinks.map((l) => (
            <li><a href={l.href}>{l.label}</a></li>
          ))}
          <li><a href="/saas-pricing/">Browse all tools</a></li>
        </ul>
      </aside>
    </div>
  </div>

  <script type="module" src={toolPageScriptUrl}></script>
</BaseLayout>
