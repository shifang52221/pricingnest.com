---
import BaseLayout from "../../layouts/BaseLayout.astro";
import AdSlot from "../../components/AdSlot.astro";
import { getToolBySlug, TOOLS, type ToolDefinition } from "../../lib/tools";
import toolPageScriptUrl from "../../scripts/tool-page.js?url";
import { compute } from "../../scripts/calculators";

export function getStaticPaths() {
  return TOOLS.map((tool) => ({ params: { slug: tool.slug } }));
}

const { slug } = Astro.params as { slug: string };
const tool = getToolBySlug(slug);
if (!tool) throw new Error(`Unknown tool slug: ${slug}`);

const relatedTools: ToolDefinition[] = tool.related
  .map((s) => getToolBySlug(s))
  .filter((t): t is ToolDefinition => Boolean(t));

const hasHowItWorks = Array.isArray(tool.howItWorks) && tool.howItWorks.length > 0;
const hasFaq = Array.isArray(tool.faq) && tool.faq.length > 0;
const hasAssumptions = Array.isArray(tool.assumptions) && tool.assumptions.length > 0;
const hasInputGuidance = Array.isArray(tool.inputGuidance) && tool.inputGuidance.length > 0;
const hasValidationChecks = Array.isArray(tool.validationChecks) && tool.validationChecks.length > 0;
const hasCommonMistakes = Array.isArray(tool.commonMistakes) && tool.commonMistakes.length > 0;
const hasInterpretation = Array.isArray(tool.interpretation) && tool.interpretation.length > 0;
const hasUseCases = Array.isArray(tool.useCases) && tool.useCases.length > 0;
const hasWalkthroughs = Array.isArray(tool.walkthroughs) && tool.walkthroughs.length > 0;
const hasScenarios = Array.isArray(tool.scenarios) && tool.scenarios.length > 0;
const hasEdgeCases = Array.isArray(tool.edgeCases) && tool.edgeCases.length > 0;

const siteUrl = (Astro.site?.toString() ?? "https://pricingnest.com").replace(/\/$/, "");
const canonical = new URL(Astro.url.pathname, siteUrl).toString();

function formatCurrency(currency: string, value: number): string {
  const formatter = new Intl.NumberFormat("en-US", {
    style: "currency",
    currency,
    maximumFractionDigits: value < 1 ? 6 : 2
  });
  return formatter.format(value);
}

function formatNumber(value: number): string {
  const formatter = new Intl.NumberFormat("en-US", { maximumFractionDigits: 6 });
  return formatter.format(value);
}

function formatPercent(value: number): string {
  const formatter = new Intl.NumberFormat("en-US", { maximumFractionDigits: 2 });
  return `${formatter.format(value)}%`;
}

function buildDefaultInputs(tool: ToolDefinition): Record<string, string> {
  const inputs: Record<string, string> = {};
  for (const input of tool.inputs) inputs[input.name] = input.defaultValue;
  return inputs;
}

const defaultInputs = buildDefaultInputs(tool);
const defaultCurrency = defaultInputs.currency || "USD";
const defaultResult = compute(tool.slug, defaultInputs);

const exampleOutputs = tool.outputs.map((out) => {
  const raw = defaultResult[out.name];
  const value =
    typeof raw === "number"
      ? out.format === "currency"
        ? formatCurrency(defaultCurrency, raw)
        : out.format === "percent"
          ? formatPercent(raw)
          : formatNumber(raw)
      : raw == null
        ? "-"
        : String(raw);

  return { ...out, value };
});

const keyInputs = tool.inputs.filter((i) => i.name !== "currency").slice(0, 3);
const websiteId = `${siteUrl}/#website`;
const breadcrumbId = `${canonical}#breadcrumb`;

const graph: any[] = [
  {
    "@type": "WebSite",
    "@id": websiteId,
    url: siteUrl,
    name: "PricingNest"
  },
  {
    "@type": "WebPage",
    "@id": canonical,
    url: canonical,
    name: tool.title,
    description: tool.description,
    isPartOf: { "@id": websiteId },
    breadcrumb: { "@id": breadcrumbId }
  },
  {
    "@type": "SoftwareApplication",
    name: tool.title,
    applicationCategory: "BusinessApplication",
    operatingSystem: "Web",
    url: canonical,
    description: tool.description,
    mainEntityOfPage: { "@id": canonical },
    isPartOf: { "@id": websiteId },
    offers: { "@type": "Offer", price: "0", priceCurrency: "USD" }
  },
  {
    "@type": "BreadcrumbList",
    "@id": breadcrumbId,
    itemListElement: [
      { "@type": "ListItem", position: 1, name: "Home", item: new URL("/", siteUrl).toString() },
      { "@type": "ListItem", position: 2, name: "SaaS Pricing Toolkit", item: new URL("/saas-pricing/", siteUrl).toString() },
      { "@type": "ListItem", position: 3, name: tool.title, item: canonical }
    ]
  }
];

if (tool.faq && tool.faq.length > 0) {
  graph.push({
    "@type": "FAQPage",
    mainEntity: tool.faq.map((f) => ({
      "@type": "Question",
      name: f.q,
      acceptedAnswer: { "@type": "Answer", text: f.a }
    }))
  });
}

const jsonLd = { "@context": "https://schema.org", "@graph": graph };

const useCaseLinks = (() => {
  const unitEconomics = new Set([
    "mrr-calculator",
    "arr-calculator",
    "churn-impact-calculator",
    "ltv-calculator",
    "cac-payback-period-calculator",
    "break-even-cac-calculator"
  ]);

  const experiments = new Set(["pricing-increase-impact-calculator", "annual-discount-calculator"]);

  const usagePricing = new Set([
    "usage-based-pricing-calculator",
    "seat-vs-usage-pricing-comparison",
    "api-pricing-calculator"
  ]);

  const infra = new Set([
    "bandwidth-cost-calculator",
    "storage-cost-calculator",
    "compute-cost-estimator",
    "monthly-cloud-cost-estimator"
  ]);

  const links: { href: string; label: string }[] = [{ href: "/saas-pricing/use-cases/", label: "All use cases" }];
  if (usagePricing.has(tool.slug)) links.push({ href: "/saas-pricing/use-cases/usage-based-pricing/", label: "Use case: usage-based pricing" });
  if (tool.slug === "api-pricing-calculator") links.push({ href: "/saas-pricing/use-cases/api-pricing/", label: "Use case: API pricing" });
  if (infra.has(tool.slug)) links.push({ href: "/saas-pricing/use-cases/infra-cost-recovery/", label: "Use case: infra cost recovery" });
  if (unitEconomics.has(tool.slug)) links.push({ href: "/saas-pricing/use-cases/unit-economics/", label: "Use case: SaaS unit economics" });
  if (experiments.has(tool.slug)) links.push({ href: "/saas-pricing/use-cases/pricing-experiments/", label: "Use case: pricing experiments" });
  return links;
})();

const guideLinks = (() => {
  const grossMarginRelated = new Set([
    "usage-based-pricing-calculator",
    "compute-cost-estimator",
    "bandwidth-cost-calculator",
    "storage-cost-calculator",
    "monthly-cloud-cost-estimator",
    "api-pricing-calculator"
  ]);

  const seatVsUsageRelated = new Set([
    "seat-vs-usage-pricing-comparison",
    "usage-based-pricing-calculator",
    "api-pricing-calculator"
  ]);

  const experimentsRelated = new Set([
    "pricing-increase-impact-calculator",
    "annual-discount-calculator",
    "churn-impact-calculator",
    "mrr-calculator"
  ]);

  const usageExamplesRelated = new Set(["usage-based-pricing-calculator", "api-pricing-calculator", "storage-cost-calculator"]);
  const annualDiscountRelated = new Set(["annual-discount-calculator", "pricing-increase-impact-calculator", "churn-impact-calculator"]);
  const apiPricingRelated = new Set(["api-pricing-calculator", "usage-based-pricing-calculator"]);
  const apiCostRelated = new Set(["api-cost-estimator", "api-pricing-calculator", "usage-based-pricing-calculator"]);
  const tieredUsageRelated = new Set(["tiered-usage-pricing-calculator", "usage-based-pricing-calculator", "seat-vs-usage-pricing-comparison"]);
  const storageRelated = new Set(["storage-cost-calculator", "bandwidth-cost-calculator", "price-per-gb-month-calculator"]);
  const computeRelated = new Set(["compute-cost-estimator"]);
  const cloudCostRelated = new Set(["monthly-cloud-cost-estimator"]);
  const breakEvenRelated = new Set(["break-even-cac-calculator", "cac-payback-period-calculator", "ltv-calculator"]);
  const usageFloorRelated = new Set([
    "usage-based-pricing-calculator",
    "tiered-usage-pricing-calculator",
    "api-pricing-calculator"
  ]);
  const nrrRelated = new Set(["nrr-calculator", "mrr-calculator", "churn-impact-calculator"]);
  const retentionRelated = new Set(["cohort-retention-curve-calculator", "ltv-calculator", "churn-impact-calculator"]);
  const tierOptimizerRelated = new Set(["pricing-tier-optimizer", "usage-based-pricing-calculator", "pricing-increase-impact-calculator"]);
  const metricsRelated = new Set([
    "mrr-calculator",
    "arr-calculator",
    "churn-impact-calculator",
    "ltv-calculator",
    "cac-payback-period-calculator",
    "break-even-cac-calculator"
  ]);

  const links: { href: string; label: string }[] = [];
  if (grossMarginRelated.has(tool.slug)) links.push({ href: "/guides/saas-gross-margin-targets/", label: "Guide: gross margin targets" });
  if (grossMarginRelated.has(tool.slug)) links.push({ href: "/guides/price-floor-by-margin/", label: "Guide: price floor by margin" });
  if (grossMarginRelated.has(tool.slug)) links.push({ href: "/guides/support-cost-allocation/", label: "Guide: support cost allocation" });
  if (usageExamplesRelated.has(tool.slug)) links.push({ href: "/guides/usage-based-pricing-examples/", label: "Guide: usage pricing examples" });
  if (usageExamplesRelated.has(tool.slug)) links.push({ href: "/guides/usage-mix-modeling/", label: "Guide: usage mix modeling" });
  if (apiPricingRelated.has(tool.slug)) links.push({ href: "/guides/api-pricing-model/", label: "Guide: API pricing model" });
  if (apiPricingRelated.has(tool.slug)) links.push({ href: "/guides/api-rate-limit-pricing/", label: "Guide: API rate limit pricing" });
  if (apiPricingRelated.has(tool.slug)) links.push({ href: "/guides/credit-based-pricing-model/", label: "Guide: credit-based pricing" });
  if (apiPricingRelated.has(tool.slug)) links.push({ href: "/guides/commit-and-consume-pricing/", label: "Guide: commit-and-consume pricing" });
  if (apiPricingRelated.has(tool.slug)) links.push({ href: "/guides/api-overage-automation/", label: "Guide: API overage automation" });
  if (apiCostRelated.has(tool.slug)) links.push({ href: "/guides/api-cost-estimation/", label: "Guide: API cost estimation" });
  if (apiPricingRelated.has(tool.slug)) links.push({ href: "/guides/request-pricing-model/", label: "Guide: request pricing model" });
  if (tieredUsageRelated.has(tool.slug)) links.push({ href: "/guides/tiered-usage-pricing/", label: "Guide: tiered usage pricing" });
  if (tieredUsageRelated.has(tool.slug)) links.push({ href: "/guides/included-usage-design/", label: "Guide: included usage design" });
  if (tieredUsageRelated.has(tool.slug)) links.push({ href: "/guides/usage-alerts-design/", label: "Guide: usage alerts design" });
  if (tieredUsageRelated.has(tool.slug)) links.push({ href: "/guides/overage-communication/", label: "Guide: overage communication" });
  if (tieredUsageRelated.has(tool.slug)) links.push({ href: "/guides/fair-use-policy-design/", label: "Guide: fair use policy design" });
  if (tieredUsageRelated.has(tool.slug)) links.push({ href: "/guides/pricing-metric-validation/", label: "Guide: pricing metric validation" });
  if (tieredUsageRelated.has(tool.slug)) links.push({ href: "/guides/credit-based-pricing-model/", label: "Guide: credit-based pricing" });
  if (tieredUsageRelated.has(tool.slug)) links.push({ href: "/guides/commit-and-consume-pricing/", label: "Guide: commit-and-consume pricing" });
  if (tieredUsageRelated.has(tool.slug)) links.push({ href: "/guides/usage-spike-protection/", label: "Guide: usage spike protection" });
  if (tieredUsageRelated.has(tool.slug)) links.push({ href: "/guides/api-overage-automation/", label: "Guide: API overage automation" });
  if (tieredUsageRelated.has(tool.slug)) links.push({ href: "/guides/usage-pricing-onboarding/", label: "Guide: usage pricing onboarding" });
  if (tieredUsageRelated.has(tool.slug)) links.push({ href: "/guides/usage-reporting-dashboard/", label: "Guide: usage reporting dashboard" });
  if (tieredUsageRelated.has(tool.slug)) links.push({ href: "/guides/usage-estimation-guide/", label: "Guide: usage estimation guide" });
  if (tieredUsageRelated.has(tool.slug)) links.push({ href: "/guides/usage-credit-expiration-policy/", label: "Guide: usage credit expiration policy" });
  if (tieredUsageRelated.has(tool.slug)) links.push({ href: "/guides/trial-usage-limit-design/", label: "Guide: trial usage limit design" });
  if (storageRelated.has(tool.slug)) links.push({ href: "/guides/storage-costs-and-pricing/", label: "Guide: storage costs & pricing" });
  if (storageRelated.has(tool.slug)) links.push({ href: "/guides/usage-allocation-cost/", label: "Guide: usage allocation for cost" });
  if (storageRelated.has(tool.slug)) links.push({ href: "/guides/storage-retrieval-fees/", label: "Guide: storage retrieval fees" });
  if (storageRelated.has(tool.slug)) links.push({ href: "/guides/cdn-cost-pass-through/", label: "Guide: CDN cost pass-through" });
  if (storageRelated.has(tool.slug)) links.push({ href: "/guides/egress-pricing-playbook/", label: "Guide: egress pricing playbook" });
  if (storageRelated.has(tool.slug)) links.push({ href: "/guides/replication-pricing/", label: "Guide: replication pricing" });
  if (computeRelated.has(tool.slug)) links.push({ href: "/guides/compute-cost-modeling/", label: "Guide: compute cost modeling" });
  if (computeRelated.has(tool.slug)) links.push({ href: "/guides/capacity-planning-pricing/", label: "Guide: capacity planning for pricing" });
  if (cloudCostRelated.has(tool.slug)) links.push({ href: "/guides/monthly-cloud-cost-breakdown/", label: "Guide: monthly cloud cost breakdown" });
  if (breakEvenRelated.has(tool.slug)) links.push({ href: "/guides/break-even-cac-guide/", label: "Guide: break-even CAC" });
  if (breakEvenRelated.has(tool.slug)) links.push({ href: "/guides/ltv-sensitivity-analysis/", label: "Guide: LTV sensitivity analysis" });
  if (breakEvenRelated.has(tool.slug)) links.push({ href: "/guides/cac-payback-scenarios/", label: "Guide: CAC payback scenarios" });
  if (breakEvenRelated.has(tool.slug)) links.push({ href: "/guides/ltv-cac-range/", label: "Guide: LTV to CAC range" });
  if (usageFloorRelated.has(tool.slug)) links.push({ href: "/guides/usage-pricing-floor/", label: "Guide: usage pricing floors" });
  if (usageFloorRelated.has(tool.slug)) links.push({ href: "/guides/usage-forecasting-pricing/", label: "Guide: usage forecasting for pricing" });
  if (nrrRelated.has(tool.slug)) links.push({ href: "/guides/nrr-playbook/", label: "Guide: NRR playbook" });
  if (nrrRelated.has(tool.slug)) links.push({ href: "/guides/grr-vs-nrr/", label: "Guide: GRR vs NRR" });
  if (nrrRelated.has(tool.slug)) links.push({ href: "/guides/expansion-revenue-modeling/", label: "Guide: expansion revenue modeling" });
  if (nrrRelated.has(tool.slug)) links.push({ href: "/guides/expansion-forecasting/", label: "Guide: expansion forecasting" });
  if (nrrRelated.has(tool.slug)) links.push({ href: "/guides/net-new-mrr-bridge/", label: "Guide: net new MRR bridge" });
  if (nrrRelated.has(tool.slug)) links.push({ href: "/guides/revenue-vs-logo-churn/", label: "Guide: revenue vs logo churn" });
  if (nrrRelated.has(tool.slug)) links.push({ href: "/guides/downgrade-prevention/", label: "Guide: downgrade prevention" });
  if (nrrRelated.has(tool.slug)) links.push({ href: "/guides/mrr-expansion-tracking/", label: "Guide: MRR expansion tracking" });
  if (nrrRelated.has(tool.slug)) links.push({ href: "/guides/renewal-forecasting/", label: "Guide: renewal forecasting" });
  if (nrrRelated.has(tool.slug)) links.push({ href: "/guides/churn-risk-scoring/", label: "Guide: churn risk scoring" });
  if (retentionRelated.has(tool.slug)) links.push({ href: "/guides/cohort-retention-playbook/", label: "Guide: cohort retention" });
  if (retentionRelated.has(tool.slug)) links.push({ href: "/guides/retention-curve-analysis/", label: "Guide: retention curve analysis" });
  if (retentionRelated.has(tool.slug)) links.push({ href: "/guides/retention-early-warning-signals/", label: "Guide: retention early warning signals" });
  if (retentionRelated.has(tool.slug)) links.push({ href: "/guides/churn-reduction-playbook/", label: "Guide: churn reduction playbook" });
  if (retentionRelated.has(tool.slug)) links.push({ href: "/guides/churn-survey-insights/", label: "Guide: churn survey insights" });
  if (retentionRelated.has(tool.slug)) links.push({ href: "/guides/onboarding-to-retention/", label: "Guide: onboarding to retention" });
  if (retentionRelated.has(tool.slug)) links.push({ href: "/guides/retention-cohort-benchmarks/", label: "Guide: retention cohort benchmarks" });
  if (retentionRelated.has(tool.slug)) links.push({ href: "/guides/renewal-forecasting/", label: "Guide: renewal forecasting" });
  if (retentionRelated.has(tool.slug)) links.push({ href: "/guides/expansion-forecasting/", label: "Guide: expansion forecasting" });
  if (retentionRelated.has(tool.slug)) links.push({ href: "/guides/billing-dunning-strategy/", label: "Guide: billing dunning strategy" });
  if (retentionRelated.has(tool.slug)) links.push({ href: "/guides/retention-campaign-calendar/", label: "Guide: retention campaign calendar" });
  if (retentionRelated.has(tool.slug)) links.push({ href: "/guides/churn-risk-scoring/", label: "Guide: churn risk scoring" });
  if (tierOptimizerRelated.has(tool.slug)) links.push({ href: "/guides/pricing-tier-design/", label: "Guide: pricing tier design" });
  if (tierOptimizerRelated.has(tool.slug)) links.push({ href: "/guides/pricing-tier-mistakes/", label: "Guide: tier pricing mistakes" });
  if (tierOptimizerRelated.has(tool.slug)) links.push({ href: "/guides/pricing-migration-plan/", label: "Guide: pricing migration plan" });
  if (tierOptimizerRelated.has(tool.slug)) links.push({ href: "/guides/pricing-page-comparison-table/", label: "Guide: pricing page comparison table" });
  if (tierOptimizerRelated.has(tool.slug)) links.push({ href: "/guides/platform-fee-strategy/", label: "Guide: platform fee strategy" });
  if (tierOptimizerRelated.has(tool.slug)) links.push({ href: "/guides/value-metric-selection/", label: "Guide: value metric selection" });
  if (tierOptimizerRelated.has(tool.slug)) links.push({ href: "/guides/minimum-commitment-model/", label: "Guide: minimum commitment modeling" });
  if (tierOptimizerRelated.has(tool.slug)) links.push({ href: "/guides/enterprise-pricing-guardrails/", label: "Guide: enterprise pricing guardrails" });
  if (tierOptimizerRelated.has(tool.slug)) links.push({ href: "/guides/addon-pricing-strategy/", label: "Guide: add-on pricing strategy" });
  if (tierOptimizerRelated.has(tool.slug)) links.push({ href: "/guides/pricing-page-faqs/", label: "Guide: pricing page FAQs" });
  if (tierOptimizerRelated.has(tool.slug)) links.push({ href: "/guides/pricing-page-copy/", label: "Guide: pricing page copy" });
  if (tierOptimizerRelated.has(tool.slug)) links.push({ href: "/guides/pricing-page-layout-checklist/", label: "Guide: pricing page layout checklist" });
  if (tierOptimizerRelated.has(tool.slug)) links.push({ href: "/guides/pricing-page-cta-optimization/", label: "Guide: pricing page CTA optimization" });
  if (tierOptimizerRelated.has(tool.slug)) links.push({ href: "/guides/pricing-page-trust-elements/", label: "Guide: pricing page trust elements" });
  if (tierOptimizerRelated.has(tool.slug)) links.push({ href: "/guides/pricing-page-competitive-positioning/", label: "Guide: pricing page competitive positioning" });
  if (tierOptimizerRelated.has(tool.slug)) links.push({ href: "/guides/pricing-page-case-studies/", label: "Guide: pricing page case studies" });
  if (tierOptimizerRelated.has(tool.slug)) links.push({ href: "/guides/tier-naming-strategy/", label: "Guide: tier naming strategy" });
  if (tierOptimizerRelated.has(tool.slug)) links.push({ href: "/guides/plan-differentiation-matrix/", label: "Guide: plan differentiation matrix" });
  if (tierOptimizerRelated.has(tool.slug)) links.push({ href: "/guides/feature-bundling-framework/", label: "Guide: feature bundling framework" });
  if (tierOptimizerRelated.has(tool.slug)) links.push({ href: "/guides/contract-minimums-messaging/", label: "Guide: contract minimums messaging" });
  if (tierOptimizerRelated.has(tool.slug)) links.push({ href: "/guides/support-tier-packaging/", label: "Guide: support tier packaging" });
  if (tierOptimizerRelated.has(tool.slug)) links.push({ href: "/guides/add-on-attach-rate-optimization/", label: "Guide: add-on attach rate optimization" });
  if (tierOptimizerRelated.has(tool.slug)) links.push({ href: "/guides/rfp-pricing-response/", label: "Guide: RFP pricing response" });
  if (tierOptimizerRelated.has(tool.slug)) links.push({ href: "/guides/partner-reseller-pricing/", label: "Guide: partner reseller pricing" });
  if (tierOptimizerRelated.has(tool.slug)) links.push({ href: "/guides/pricing-qa-checklist/", label: "Guide: pricing QA checklist" });
  if (tierOptimizerRelated.has(tool.slug)) links.push({ href: "/guides/regional-pricing-floor/", label: "Guide: regional pricing floor" });
  if (tierOptimizerRelated.has(tool.slug)) links.push({ href: "/guides/onboarding-milestone-pricing/", label: "Guide: onboarding milestone pricing" });
  if (tierOptimizerRelated.has(tool.slug)) links.push({ href: "/guides/pricing-segmentation/", label: "Guide: pricing segmentation" });
  if (tierOptimizerRelated.has(tool.slug)) links.push({ href: "/guides/seat-minimums/", label: "Guide: seat minimums" });
  if (tierOptimizerRelated.has(tool.slug)) links.push({ href: "/guides/rate-card-quoting/", label: "Guide: rate card quoting" });
  if (seatVsUsageRelated.has(tool.slug)) links.push({ href: "/guides/seat-vs-usage-pricing/", label: "Guide: seat vs usage" });
  if (seatVsUsageRelated.has(tool.slug)) links.push({ href: "/guides/seat-expansion-modeling/", label: "Guide: seat expansion modeling" });
  if (seatVsUsageRelated.has(tool.slug)) links.push({ href: "/guides/seat-minimums/", label: "Guide: seat minimums" });
  if (seatVsUsageRelated.has(tool.slug)) links.push({ href: "/guides/seat-utilization-forecast/", label: "Guide: seat utilization forecast" });
  if (experimentsRelated.has(tool.slug)) links.push({ href: "/guides/pricing-experiments-playbook/", label: "Guide: pricing experiments" });
  if (experimentsRelated.has(tool.slug)) links.push({ href: "/guides/arpa-growth-levers/", label: "Guide: ARPA growth levers" });
  if (experimentsRelated.has(tool.slug)) links.push({ href: "/guides/pricing-rollout-playbook/", label: "Guide: pricing rollout playbook" });
  if (experimentsRelated.has(tool.slug)) links.push({ href: "/guides/arrr-funnel-pricing/", label: "Guide: ARRR funnel pricing" });
  if (experimentsRelated.has(tool.slug)) links.push({ href: "/guides/ramp-pricing/", label: "Guide: ramp pricing" });
  if (experimentsRelated.has(tool.slug)) links.push({ href: "/guides/pricing-localization/", label: "Guide: pricing localization" });
  if (experimentsRelated.has(tool.slug)) links.push({ href: "/guides/price-lock-policy/", label: "Guide: price lock policy" });
  if (experimentsRelated.has(tool.slug)) links.push({ href: "/guides/price-change-communication/", label: "Guide: price change communication" });
  if (annualDiscountRelated.has(tool.slug)) links.push({ href: "/guides/annual-prepay-discount/", label: "Guide: annual discount" });
  if (annualDiscountRelated.has(tool.slug)) links.push({ href: "/guides/discount-guardrails/", label: "Guide: discount guardrails" });
  if (annualDiscountRelated.has(tool.slug)) links.push({ href: "/guides/billing-cycle-selection/", label: "Guide: billing cycle selection" });
  if (annualDiscountRelated.has(tool.slug)) links.push({ href: "/guides/sales-discount-approval/", label: "Guide: sales discount approval" });
  if (annualDiscountRelated.has(tool.slug)) links.push({ href: "/guides/annual-renewal-strategy/", label: "Guide: annual renewal strategy" });
  if (metricsRelated.has(tool.slug)) links.push({ href: "/guides/saas-metrics-cheat-sheet/", label: "Guide: SaaS metrics cheat sheet" });
  if (metricsRelated.has(tool.slug)) links.push({ href: "/guides/contract-value-modeling/", label: "Guide: contract value modeling" });
  if (metricsRelated.has(tool.slug)) links.push({ href: "/guides/revenue-recognition-basics/", label: "Guide: revenue recognition basics" });
  if (metricsRelated.has(tool.slug)) links.push({ href: "/guides/revenue-leakage-audit/", label: "Guide: revenue leakage audit" });
  if (apiPricingRelated.has(tool.slug)) links.push({ href: "/guides/api-free-tier-guardrails/", label: "Guide: API free tier guardrails" });
  if (apiPricingRelated.has(tool.slug)) links.push({ href: "/guides/platform-fee-strategy/", label: "Guide: platform fee strategy" });
  if (tieredUsageRelated.has(tool.slug)) links.push({ href: "/guides/usage-tier-breakpoints/", label: "Guide: usage tier breakpoints" });
  if (tieredUsageRelated.has(tool.slug)) links.push({ href: "/guides/overage-policy-design/", label: "Guide: overage policy design" });
  if (tieredUsageRelated.has(tool.slug)) links.push({ href: "/guides/usage-cap-design/", label: "Guide: usage cap design" });
  if (tieredUsageRelated.has(tool.slug)) links.push({ href: "/guides/usage-cap-communication/", label: "Guide: usage cap communication" });
  if (tieredUsageRelated.has(tool.slug)) links.push({ href: "/guides/tier-grace-period-design/", label: "Guide: tier grace period design" });
  if (storageRelated.has(tool.slug)) links.push({ href: "/guides/storage-cost-optimization/", label: "Guide: storage cost optimization" });
  if (computeRelated.has(tool.slug)) links.push({ href: "/guides/compute-cost-baselines/", label: "Guide: compute cost baselines" });
  if (cloudCostRelated.has(tool.slug)) links.push({ href: "/guides/monthly-cloud-cost-variance/", label: "Guide: monthly cloud cost variance" });
  links.push({ href: "/glossary/", label: "Glossary: SaaS metrics & pricing terms" });
  return links;
})();
---

<BaseLayout title={`${tool.title} | PricingNest`} description={tool.description}>
  <script slot="head" type="application/ld+json" set:html={JSON.stringify(jsonLd)} />

  <div data-tool={tool.slug}>
    {tool.presets && tool.presets.length > 0 ? (
      <script type="application/json" data-presets set:html={JSON.stringify(tool.presets)} />
    ) : null}

    <section class="hero">
      <h1>{tool.title}</h1>
      <p>{tool.description}</p>
      <nav class="crumbs" aria-label="Breadcrumb">
        <a href="/saas-pricing/">SaaS Pricing Toolkit</a>
        <span class="crumb-sep">/</span>
        <span aria-current="page">{tool.title}</span>
      </nav>
    </section>

    <div class="grid">
      <section class="card col8 split">
        <div>
          <div class="section-head">
            <h2>Inputs</h2>
            <div class="actions">
              <button type="button" data-reset>Reset</button>
              <button type="button" class="primary" data-download-csv>Download CSV</button>
            </div>
          </div>

          {tool.presets && tool.presets.length > 0 ? (
            <div class="field">
              <label for="preset">Presets</label>
              <select id="preset" data-presets-select>
                <option value="">Choose a preset...</option>
                {tool.presets.map((p) => (
                  <option value={p.label}>{p.label}</option>
                ))}
              </select>
            </div>
          ) : null}

          <div class="scenario-controls">
            <div class="section-head">
              <h2>Scenarios</h2>
              <div class="actions">
                <select data-scenario-input>
                  {tool.inputs
                    .filter((input) => input.name !== "currency" && input.type === "number")
                    .map((input) => (
                      <option value={input.name}>{input.label}</option>
                    ))}
                </select>
              </div>
            </div>
            <div class="scenario-buttons">
              <button type="button" data-scenario="p50">P50 (Base)</button>
              <button type="button" data-scenario="p90">P90 (+25%)</button>
              <button type="button" data-scenario="worst">Worst (-25%)</button>
            </div>
            <div class="muted scenario-note">
              Applies to the selected input only; adjust other inputs manually if needed.
            </div>
          </div>

          <form data-tool-form>
            {tool.inputs.map((input) => (
              <div class="field">
                <label for={input.name}>{input.label}</label>
                {input.type === "select" ? (
                  <select id={input.name} name={input.name} data-default={input.defaultValue}>
                    {(input.options ?? []).map((opt) => (
                      <option value={opt.value} selected={opt.value === input.defaultValue}>
                        {opt.label}
                      </option>
                    ))}
                  </select>
                ) : (
                  <input
                    id={input.name}
                    name={input.name}
                    type="number"
                    inputmode="decimal"
                    value={input.defaultValue}
                    data-default={input.defaultValue}
                    min={input.min}
                    step={input.step}
                  />
                )}
                {input.help ? <div class="help">{input.help}</div> : null}
              </div>
            ))}
          </form>
        </div>

        <div class="sticky">
          <h2 class="sticky-title">Results</h2>
          <div class="outputs">
            {tool.outputs.map((out) => (
              <div class="output" data-output={out.name} data-format={out.format}>
                <div class="label">{out.label}</div>
                <div class="value" data-output-value>-</div>
                <div class="sparkline" data-sparkline={out.name}>
                  <div class="sparkline-track">
                    <div class="sparkline-bar" data-sparkline-bar></div>
                  </div>
                  <div class="sparkline-label" data-sparkline-label>-</div>
                </div>
              </div>
            ))}
          </div>

          <div class="insights">
            <div class="section-head">
              <h2>Insights</h2>
              <div class="muted" style="font-size: 0.85rem;">Auto-generated from your inputs.</div>
            </div>
            <div class="insights-list" data-insights>
              <div class="muted">Adjust inputs to see recommendations.</div>
            </div>
          </div>

          <div class="share">
            <div class="muted" style="font-size: 0.9rem; margin-bottom: 0.35rem;">Share link</div>
            <div class="output" style="padding: 0.75rem;">
              <div class="muted" style="word-break: break-all;" data-share-link>-</div>
              <div class="share-actions">
                <button type="button" data-copy-share>Copy share link</button>
                <a class="muted" href="/saas-pricing/">All tools</a>
              </div>
            </div>
          </div>
        </div>
      </section>

      <aside class="card col4">
        <h2>Related tools</h2>
        <div class="tools">
          {relatedTools.map((t) => (
            <a class="tool" href={`/saas-pricing/${t.slug}/`}>
              <strong>{t.title}</strong>
              <span>{t.description}</span>
            </a>
          ))}
        </div>

        <div style="margin-top: 1rem;">
          <div class="muted" style="font-size: 0.85rem;">Advertisement</div>
          <AdSlot placement="tool" containerStyle="margin-top: 0.5rem;" />
        </div>
      </aside>
    </div>

    <div class="grid analysis">
      <section class="card col6 compare" id="compare">
        <div class="section-head">
          <h2>Compare</h2>
          <div class="actions">
            <button type="button" data-compare-save>Save baseline</button>
            <button type="button" data-compare-clear>Clear</button>
          </div>
        </div>
        <div class="muted compare-note" data-compare-note>
          Save a baseline to see deltas for every output.
        </div>
        <div class="compare-grid">
          {tool.outputs.map((out) => (
            <div class="compare-row" data-compare-output={out.name} data-format={out.format}>
              <div class="label">{out.label}</div>
              <div class="compare-values">
                <div class="compare-value">
                  <span class="compare-tag">Baseline</span>
                  <span data-compare-baseline>-</span>
                </div>
                <div class="compare-value">
                  <span class="compare-tag">Delta</span>
                  <span data-compare-delta>-</span>
                </div>
              </div>
            </div>
          ))}
        </div>
      </section>
      <section class="card col6 sensitivity" id="sensitivity">
        <div class="section-head">
          <h2>Sensitivity</h2>
          <div class="actions">
            <select data-sensitivity-input>
              {tool.inputs
                .filter((input) => input.name !== "currency" && input.type === "number")
                .map((input) => (
                  <option value={input.name}>{input.label}</option>
                ))}
            </select>
            <select data-sensitivity-range>
              <option value="10">+/- 10%</option>
              <option value="25">+/- 25%</option>
            </select>
          </div>
        </div>
        <div class="muted sensitivity-note" data-sensitivity-note>
          Adjust the input to see how outputs respond to small changes.
        </div>
        <div class="sensitivity-grid">
          {tool.outputs.map((out) => (
            <div class="sensitivity-row" data-sensitivity-output={out.name} data-format={out.format}>
              <div class="label">{out.label}</div>
              <div class="sensitivity-values">
                <div class="sensitivity-value">
                  <span class="sensitivity-tag">Low</span>
                  <span data-sensitivity-low>-</span>
                </div>
                <div class="sensitivity-value">
                  <span class="sensitivity-tag">Base</span>
                  <span data-sensitivity-base>-</span>
                </div>
                <div class="sensitivity-value">
                  <span class="sensitivity-tag">High</span>
                  <span data-sensitivity-high>-</span>
                </div>
              </div>
            </div>
          ))}
        </div>
      </section>
    </div>

    <div class="grid" style="margin-top: 1rem;">
      <section class="card col8" id="guide">
        <h2>Guide</h2>
        <p class="muted" style="margin-top: 0.5rem;">
          This page is a calculator first, but it's also a quick reference you can share internally. Start with the
          presets, then adjust inputs and copy the share link. Example defaults for this tool are shown below.
        </p>

        <div class="toc" aria-label="On this page">
          <a href="#example">Example</a>
          <a href="#inputs">Inputs</a>
          <a href="#outputs">Outputs</a>
          {hasHowItWorks ? <a href="#how">How it works</a> : null}
          {hasInputGuidance ? <a href="#guidance">Modeling tips</a> : null}
          {hasValidationChecks ? <a href="#checks">Validation checks</a> : null}
          {hasCommonMistakes ? <a href="#mistakes">Common mistakes</a> : null}
          {hasInterpretation ? <a href="#interpretation">Interpretation</a> : null}
          {hasUseCases ? <a href="#use-cases">Use cases</a> : null}
          {hasWalkthroughs ? <a href="#walkthroughs">Mini walkthroughs</a> : null}
          {hasScenarios ? <a href="#scenarios">Scenarios</a> : null}
          {hasEdgeCases ? <a href="#edges">Edge cases</a> : null}
          {hasFaq ? <a href="#faq">FAQ</a> : null}
        </div>

        <h2 id="example" style="margin-top: 1.25rem;">Example (defaults)</h2>
        <p class="muted" style="margin-top: 0.5rem;">
          Example inputs: {keyInputs.map((i, idx) => (
            <span>
              <strong>{i.label}</strong> = {i.defaultValue}{idx < keyInputs.length - 1 ? ", " : ""}
            </span>
          ))}
        </p>
        <div class="data-grid" style="margin-top: 0.8rem;">
          {exampleOutputs.map((out) => (
            <div class="data-card">
              <div class="data-label">{out.label}</div>
              <div class="data-value">{out.value}</div>
            </div>
          ))}
        </div>

        <h2 id="inputs" style="margin-top: 1.25rem;">Inputs explained</h2>
        <div class="data-table-wrap" style="margin-top: 0.65rem;">
          <table class="data-table">
            <thead>
              <tr>
                <th>Input</th>
                <th>Default</th>
                <th>Notes</th>
              </tr>
            </thead>
            <tbody>
              {tool.inputs.map((input) => (
                <tr>
                  <td>
                    <strong>{input.label}</strong>
                  </td>
                  <td><code>{input.defaultValue}</code></td>
                  <td class="muted">
                    {input.help ? input.help : "Adjust to match your product assumptions."}
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>

        <h2 id="outputs" style="margin-top: 1.25rem;">Outputs explained</h2>
        <div class="data-table-wrap" style="margin-top: 0.65rem;">
          <table class="data-table">
            <thead>
              <tr>
                <th>Output</th>
                <th>What it means</th>
              </tr>
            </thead>
            <tbody>
              {tool.outputs.map((out) => (
                <tr>
                  <td><strong>{out.label}</strong></td>
                  <td class="muted">
                    {out.format === "currency"
                      ? "A money value based on your selected currency."
                      : out.format === "percent"
                        ? "A percentage value derived from the inputs."
                        : out.format === "number"
                          ? "A numeric value derived from the inputs."
                          : "A text label derived from the inputs."}
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>

        {hasHowItWorks ? (
          <>
            <h2 id="how" style="margin-top: 1.25rem;">How it works</h2>
            <ul class="list">
              {tool.howItWorks?.map((item) => (
                <li>{item}</li>
              ))}
            </ul>
          </>
        ) : null}

        {hasInputGuidance ? (
          <>
            <h2 id="guidance" style="margin-top: 1.25rem;">Modeling tips</h2>
            <ul class="list">
              {tool.inputGuidance?.map((item) => (
                <li>{item}</li>
              ))}
            </ul>
          </>
        ) : null}

        {hasValidationChecks ? (
          <>
            <h2 id="checks" style="margin-top: 1.25rem;">Validation checks</h2>
            <ul class="list">
              {tool.validationChecks?.map((item) => (
                <li>{item}</li>
              ))}
            </ul>
          </>
        ) : null}

        {hasCommonMistakes ? (
          <>
            <h2 id="mistakes" style="margin-top: 1.25rem;">Common mistakes</h2>
            <ul class="list">
              {tool.commonMistakes?.map((item) => (
                <li>{item}</li>
              ))}
            </ul>
          </>
        ) : null}

        {hasInterpretation ? (
          <>
            <h2 id="interpretation" style="margin-top: 1.25rem;">Interpretation</h2>
            <ul class="list">
              {tool.interpretation?.map((item) => (
                <li>{item}</li>
              ))}
            </ul>
          </>
        ) : null}

        {hasUseCases ? (
          <>
            <h2 id="use-cases" style="margin-top: 1.25rem;">Use cases</h2>
            <div class="data-grid" style="margin-top: 0.8rem;">
              {tool.useCases?.map((s) => (
                <div class="data-card">
                  <div class="data-label">{s.title}</div>
                  <div class="data-value" style="font-size: 0.95rem; font-weight: 500; line-height: 1.5;">
                    {s.detail}
                  </div>
                </div>
              ))}
            </div>
          </>
        ) : null}

        {hasWalkthroughs ? (
          <>
            <h2 id="walkthroughs" style="margin-top: 1.25rem;">Mini walkthroughs</h2>
            <div class="data-grid" style="margin-top: 0.8rem;">
              {tool.walkthroughs?.map((w) => (
                <div class="data-card">
                  <div class="data-label">{w.title}</div>
                  <ol class="list" style="margin-top: 0.45rem;">
                    {w.steps.map((step) => (
                      <li>{step}</li>
                    ))}
                  </ol>
                </div>
              ))}
            </div>
          </>
        ) : null}

        {hasScenarios ? (
          <>
            <h2 id="scenarios" style="margin-top: 1.25rem;">Scenarios</h2>
            <div class="data-grid" style="margin-top: 0.8rem;">
              {tool.scenarios?.map((s) => (
                <div class="data-card">
                  <div class="data-label">{s.title}</div>
                  <div class="data-value" style="font-size: 0.95rem; font-weight: 500; line-height: 1.5;">
                    {s.detail}
                  </div>
                </div>
              ))}
            </div>
          </>
        ) : null}

        {hasEdgeCases ? (
          <>
            <h2 id="edges" style="margin-top: 1.25rem;">Edge cases</h2>
            <ul class="list">
              {tool.edgeCases?.map((item) => (
                <li>{item}</li>
              ))}
            </ul>
          </>
        ) : null}

        {hasFaq ? (
          <>
            <h2 id="faq" style="margin-top: 1.25rem;">FAQ</h2>
            <div class="faq">
              {tool.faq?.map((f) => (
                <details class="faq-item">
                  <summary>{f.q}</summary>
                  <div class="muted faq-answer">{f.a}</div>
                </details>
              ))}
            </div>
          </>
        ) : null}
      </section>

      <aside class="card col4">
        {hasAssumptions ? (
          <>
            <h2>Assumptions</h2>
            <ul class="list">
              {tool.assumptions?.map((item) => (
                <li>{item}</li>
              ))}
            </ul>
          </>
        ) : null}

        <h2 style="margin-top: 1.25rem;">Next steps</h2>
        <div class="muted" style="margin-top: 0.5rem;">Suggested actions</div>
        <ul class="list">
          <li><a href="#compare">Save a baseline in Compare</a></li>
          <li><a href="#sensitivity">Run a sensitivity sweep</a></li>
          <li>Copy the share link and download a CSV</li>
        </ul>
        <div class="muted" style="margin-top: 0.75rem;">More to explore</div>
        <ul class="list">
          {useCaseLinks.map((l) => (
            <li><a href={l.href}>{l.label}</a></li>
          ))}
          {guideLinks.map((l) => (
            <li><a href={l.href}>{l.label}</a></li>
          ))}
          <li><a href="/saas-pricing/">Browse all tools</a></li>
        </ul>
      </aside>
    </div>
  </div>

  <script type="module" src={toolPageScriptUrl}></script>
</BaseLayout>
