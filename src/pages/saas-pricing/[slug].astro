---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { getToolBySlug, TOOLS, type ToolDefinition } from "../../lib/tools";
import toolPageScriptUrl from "../../scripts/tool-page.ts?url";

export function getStaticPaths() {
  return TOOLS.map((tool) => ({ params: { slug: tool.slug } }));
}

const { slug } = Astro.params as { slug: string };
const tool = getToolBySlug(slug);
if (!tool) throw new Error(`Unknown tool slug: ${slug}`);

const relatedTools: ToolDefinition[] = tool.related
  .map((s) => getToolBySlug(s))
  .filter((t): t is ToolDefinition => Boolean(t));

const siteUrl = (Astro.site?.toString() ?? "https://pricingnest.com").replace(/\/$/, "");
const canonical = new URL(Astro.url.pathname, siteUrl).toString();

const graph: any[] = [
  {
    "@type": "SoftwareApplication",
    name: tool.title,
    applicationCategory: "BusinessApplication",
    operatingSystem: "Web",
    url: canonical,
    description: tool.description,
    offers: { "@type": "Offer", price: "0", priceCurrency: "USD" }
  },
  {
    "@type": "BreadcrumbList",
    itemListElement: [
      { "@type": "ListItem", position: 1, name: "Home", item: new URL("/", siteUrl).toString() },
      { "@type": "ListItem", position: 2, name: "SaaS Pricing Toolkit", item: new URL("/saas-pricing/", siteUrl).toString() },
      { "@type": "ListItem", position: 3, name: tool.title, item: canonical }
    ]
  }
];

if (tool.faq && tool.faq.length > 0) {
  graph.push({
    "@type": "FAQPage",
    mainEntity: tool.faq.map((f) => ({
      "@type": "Question",
      name: f.q,
      acceptedAnswer: { "@type": "Answer", text: f.a }
    }))
  });
}

const jsonLd = { "@context": "https://schema.org", "@graph": graph };
---

<BaseLayout title={`${tool.title} | PricingNest`} description={tool.description}>
  <script slot="head" type="application/ld+json" set:html={JSON.stringify(jsonLd)} />

  <div data-tool={tool.slug}>
    {tool.presets && tool.presets.length > 0 ? (
      <script type="application/json" data-presets set:html={JSON.stringify(tool.presets)} />
    ) : null}

    <section class="hero">
      <h1>{tool.title}</h1>
      <p>{tool.description}</p>
      <nav class="crumbs" aria-label="Breadcrumb">
        <a href="/saas-pricing/">SaaS Pricing Toolkit</a>
        <span class="crumb-sep">/</span>
        <span aria-current="page">{tool.title}</span>
      </nav>
    </section>

    <div class="grid">
      <section class="card col8 split">
        <div>
          <div class="section-head">
            <h2>Inputs</h2>
            <div class="actions">
              <button type="button" data-reset>Reset</button>
              <button type="button" class="primary" data-download-csv>Download CSV</button>
            </div>
          </div>

          {tool.presets && tool.presets.length > 0 ? (
            <div class="field">
              <label for="preset">Presets</label>
              <select id="preset" data-presets-select>
                <option value="">Choose a preset...</option>
                {tool.presets.map((p) => (
                  <option value={p.label}>{p.label}</option>
                ))}
              </select>
            </div>
          ) : null}

          <form data-tool-form>
            {tool.inputs.map((input) => (
              <div class="field">
                <label for={input.name}>{input.label}</label>
                {input.type === "select" ? (
                  <select id={input.name} name={input.name} data-default={input.defaultValue}>
                    {(input.options ?? []).map((opt) => (
                      <option value={opt.value} selected={opt.value === input.defaultValue}>
                        {opt.label}
                      </option>
                    ))}
                  </select>
                ) : (
                  <input
                    id={input.name}
                    name={input.name}
                    type="number"
                    inputmode="decimal"
                    value={input.defaultValue}
                    data-default={input.defaultValue}
                    min={input.min}
                    step={input.step}
                  />
                )}
                {input.help ? <div class="help">{input.help}</div> : null}
              </div>
            ))}
          </form>

          <div class="ad">Ad slot (optional): responsive unit under the form.</div>
        </div>

        <div class="sticky">
          <h2 class="sticky-title">Results</h2>
          <div class="outputs">
            {tool.outputs.map((out) => (
              <div class="output" data-output={out.name} data-format={out.format}>
                <div class="label">{out.label}</div>
                <div class="value" data-output-value>-</div>
              </div>
            ))}
          </div>

          <div class="share">
            <div class="muted" style="font-size: 0.9rem; margin-bottom: 0.35rem;">Share link</div>
            <div class="output" style="padding: 0.75rem;">
              <div class="muted" style="word-break: break-all;" data-share-link>-</div>
              <div class="share-actions">
                <button type="button" data-copy-share>Copy share link</button>
                <a class="muted" href="/saas-pricing/">All tools</a>
              </div>
            </div>
          </div>
        </div>
      </section>

      <aside class="card col4">
        <h2>Related tools</h2>
        <div class="tools">
          {relatedTools.map((t) => (
            <a class="tool" href={`/saas-pricing/${t.slug}/`}>
              <strong>{t.title}</strong>
              <span>{t.description}</span>
            </a>
          ))}
        </div>
      </aside>
    </div>

    {(tool.howItWorks && tool.howItWorks.length > 0) ||
    (tool.assumptions && tool.assumptions.length > 0) ||
    (tool.faq && tool.faq.length > 0) ? (
      <div class="grid">
        <section class="card col8">
          {tool.howItWorks && tool.howItWorks.length > 0 ? (
            <>
              <h2>How it works</h2>
              <ul class="list">
                {tool.howItWorks.map((item) => (
                  <li>{item}</li>
                ))}
              </ul>
            </>
          ) : null}

          {tool.faq && tool.faq.length > 0 ? (
            <>
              <h2 style="margin-top: 1.25rem;">FAQ</h2>
              <div class="faq">
                {tool.faq.map((f) => (
                  <details class="faq-item">
                    <summary>{f.q}</summary>
                    <div class="muted faq-answer">{f.a}</div>
                  </details>
                ))}
              </div>
            </>
          ) : null}
        </section>

        <aside class="card col4">
          {tool.assumptions && tool.assumptions.length > 0 ? (
            <>
              <h2>Assumptions</h2>
              <ul class="list">
                {tool.assumptions.map((item) => (
                  <li>{item}</li>
                ))}
              </ul>
            </>
          ) : (
            <>
              <h2>Notes</h2>
              <p class="muted">Use presets to start, then adjust assumptions and share the link with your team.</p>
            </>
          )}
        </aside>
      </div>
    ) : null}
  </div>

  <script type="module" src={toolPageScriptUrl}></script>
</BaseLayout>
